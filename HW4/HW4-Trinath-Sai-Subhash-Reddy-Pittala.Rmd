---
title: "HW4-Trinath Sai Subhash Reddy"
author: "Subhash"
date: "`r Sys.Date()`"
output:
  pdf_document:
    keep_tex: yes
  html_document:
    code_folding: hide
    word_wrap: true
---

```{r setup, include=FALSE}
library(formatR)
library(tidyverse)
library(GGally)
library(ggfortify)
library(nycflights13)
library(modelr)
library(magick)
library(haven)
library(dplyr)
library(ISLR)
library(broom)
library(lubridate)
library(ggplot2)
library(nycflights13)
library(knitr)
library(caret)
library(car)
library(kableExtra)

knitr::opts_chunk$set(width = 60, warning = FALSE, message = FALSE, tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = TRUE, dev = "png")
#knitr::opts_chunk$set(echo = TRUE)

```

# Polynomial regression and interaction effects

We will be using the flights dataset from the nycflights13 package as for other assignments. We will first explore polynomial regression.
a. Create the flights.sm dataset as in the previous assignment containing only the following variables: arr_delay, dep_delay, sched_dep_time, distance, air_time.

```{r}
flights.sm <- flights[, c("arr_delay", "dep_delay", "sched_dep_time", "distance", "air_time")]
```

b. With arr_delay as the DV and all other variables as IVs, explore the linearity or non-linearity of the other IVs to arr_delay graphically. Comment on whether it is clear what polynomial order should be used for the relationship between any of the IVs and the DV (i.e., what is the order for dep_delay vs arr_delay, for air_time vs arr_delay etc.). (Hint: Note that we are only considering polynomial relationships and many of these IVs have a non-obvious polynomial relationship from the graphs, in which case mention that).

```{r}
# Scatter plot matrix with regression lines
ggplot(flights.sm, aes(x = dep_delay, y = arr_delay)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(title = "Arrival Delay vs. Departure Delay") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(flights.sm, aes(x = sched_dep_time, y = arr_delay)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(title = "Arrival Delay vs. Scheduled Departure Time") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(flights.sm, aes(x = distance, y = arr_delay)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(title = "Arrival Delay vs. Distance") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(flights.sm, aes(x = air_time, y = arr_delay)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  labs(title = "Arrival Delay vs. Air Time") +
  theme(plot.title = element_text(hjust = 0.5))
```

Based on the scatter plots and regression lines, it is not clear whether any of the IVs have a clear polynomial relationship with the DV. The relationships appear to be mostly linear, with some indication of non-linearity in the distance vs. arrival delay plot. In this case, we may need to consider other types of models or transformations of the variables to capture the relationships. Therefore, we cannot conclude which polynomial order should be used for the relationship between any of the IVs and the DV.

From the scatter plots with fitted lines, it is clear that a linear relationship between arr_delay and the other IVs (dep_delay, air_time, sched_dep_time, and distance) does not hold. In particular, for dep_delay and air_time, the relationship appears to be non-linear, and for sched_dep_time and distance, there is no obvious relationship at all.

For dep_delay and air_time, we can try fitting a polynomial regression model with different orders to see which one fits the data best. For sched_dep_time and distance, we may want to consider other types of regression models (e.g., categorical or interaction models) since a polynomial relationship is not clear from the scatter plots.

c. Build a “full” polynomial regression model with every variable allowed to have up to degree 3. Do this first manually by creating for each variable its power polynomials. This is done by creating a dep_delay2 variable which is dep_delayˆ2 and a dep_delay3 variable, which is dep_delayˆ3, and similarly for the other IVs. Now, put all these variables into a linear model using the lm() function. Call this full model M1 and output summary function. Use the poly() function shown in class (using the “raw” setting so as to avoid orthogonal polynomials) to do this automatically and call this model M2. Check whether there is any difference between M1 and M2.

```{r}
# Creating power polynomials for each variable
flights.sm$dep_delay2 <- flights.sm$dep_delay^2
flights.sm$dep_delay3 <- flights.sm$dep_delay^3
flights.sm$arr_delay2 <- flights.sm$arr_delay^2
flights.sm$arr_delay3 <- flights.sm$arr_delay^3
flights.sm$air_time2 <- flights.sm$air_time^2
flights.sm$air_time3 <- flights.sm$air_time^3
flights.sm$sched_dep_time2 <- flights.sm$sched_dep_time^2
flights.sm$sched_dep_time3 <- flights.sm$sched_dep_time^3
flights.sm$distance2 <- flights.sm$distance^2
flights.sm$distance3 <- flights.sm$distance^3

# Creating full polynomial regression model manually
M1 <- lm(arr_delay ~ dep_delay + dep_delay2 + dep_delay3 + air_time + air_time2 + air_time3 + 
                sched_dep_time + sched_dep_time2 + sched_dep_time3 + distance + distance2 + distance3,
         data = flights.sm)

# Outputting summary function
summary(M1)
```

```{r}
# Creating full polynomial regression model using poly() function
M2 <- lm(arr_delay ~ poly(dep_delay, 3, raw = TRUE) + poly(air_time, 3, raw = TRUE) +
                poly(sched_dep_time, 3, raw = TRUE) + poly(distance, 3, raw = TRUE),
         data = flights.sm)

# Outputting summary function
summary(M2)
```

Comparing the two models M1 and M2, we can see that they have identical R-squared values and coefficients, so there is no significant difference between the two models.

d. For M1, explain what each regression coefficient indicates, and explain what the rate of change of the DV with respect to each IV is (when all other IVs are kept constant). Comment on the statistical significance of different variables, and the overall Rˆ2 value.

The coefficient for dep_delay suggests that for every unit increase in dep_delay, arr_delay increases by 1.055e+00 units. The coefficient for dep_delay2 indicates that for every unit increase in dep_delay squared, arr_delay decreases by 2.081e-04 units. The coefficient for dep_delay3 suggests that for every unit increase in dep_delay cubed, arr_delay increases by 1.459e-07 units.

The coefficient for air_time indicates that for every unit increase in air_time, arr_delay increases by 9.789e-01 units. The coefficient for air_time2 suggests that for every unit increase in air_time squared, arr_delay decreases by 1.145e-03 units. The coefficient for air_time3 indicates that for every unit increase in air_time cubed, arr_delay increases by 1.293e-06 units.

The coefficient for sched_dep_time indicates that for every unit increase in sched_dep_time, arr_delay increases by 4.058e-02 units. The coefficient for sched_dep_time2 suggests that for every unit increase in sched_dep_time squared, arr_delay decreases by 3.462e-05 units. The coefficient for sched_dep_time3 indicates that for every unit increase in sched_dep_time cubed, arr_delay increases by 8.925e-09 units.

The coefficient for distance suggests that for every unit increase in distance, arr_delay decreases by 1.192e-01 units. The coefficient for distance2 indicates that for every unit increase in distance squared, arr_delay increases by 1.464e-05 units. The coefficient for distance3 suggests that for every unit increase in distance cubed, arr_delay decreases by 1.900e-09 units.

e. Create standardized IVs by doing dep_delay.std <- (dep_delay - mean(dep_delay))/sd(dep_delay) and similarly for other IVs. Build models M3 and M4 similar to M1 and M2 but using the standardized IVs. Show the output summary and comment on the statistical significance of the variables and the Rˆ2 value.

```{r}

# Create standardized independent variables
flights.sm$dep_delay.std <- scale(flights.sm$dep_delay)
flights.sm$arr_delay.std <- scale(flights.sm$arr_delay)
flights.sm$sched_dep_time.std <- scale(flights.sm$sched_dep_time)
flights.sm$distance.std <- scale(flights.sm$distance)
flights.sm$air_time.std <- scale(flights.sm$air_time)

# Build full polynomial regression model manually
M3 <- lm(arr_delay.std ~ dep_delay.std + I(dep_delay.std^2) + I(dep_delay.std^3) + 
              air_time.std + I(air_time.std^2) + I(air_time.std^3) +
              sched_dep_time.std + I(sched_dep_time.std^2) + I(sched_dep_time.std^3) +
              distance.std + I(distance.std^2) + I(distance.std^3), data = flights.sm)

# Build full polynomial regression model using poly() function
M4 <- lm(arr_delay.std ~ poly(dep_delay.std, 3, raw = TRUE) + poly(air_time.std, 3, raw = TRUE) +
              poly(sched_dep_time.std, 3, raw = TRUE) + poly(distance.std, 3, raw = TRUE), data = flights.sm)

# Output summary for M3 and M4
summary(M3)
summary(M4)
```

In terms of statistical significance, all the variables in M3 and M4 are significant, and the overall Rˆ2 values are still similar to those in M1 and M2. However, the standardized coefficients in M3 and M4 can be directly compared to see which variables have a relatively larger effect on the outcome variable.

f. Run a backward stepwise regression on the full model to select the best model overall (M5). Show the summary output of the final selected model and comment on what variables have been dropped and what degree polynomial relationship is finally selected between each IV and the DV.

```{r}
# backward stepwise regression on full model
M5 <- step(M1, direction = "backward", scope = list(lower = ~ 1, upper = M1))
summary(M5)
```


No variables were dropped. All IVs have their powers till 3.

g. Test for interaction effects between dep_delay and air_time, dep_delay and sched_dep_time, and air_time and sched_dep_time. For this, set the polynomial relationship between each of these IVs to what you finalized in part f, then test for all possible interactions between terms involving dep_delay and air_time etc. For example, if the relationship is found to be linear for dep_delay and quadratic for air_time, then you should create terms corresponding to dep_delay*air_time, dep_delay*air_timeˆ2 and build a full model M6 that contains all these relevant terms. Run a stepwise regression on M6 to obtain the best possible model M7. Comment on what terms were selected in M7 and how each coefficient can be interpreted.

```{r}
# create interaction terms
flights.sm$dep_delay2 <- flights.sm$dep_delay^2
flights.sm$dep_delay3 <- flights.sm$dep_delay^3
flights.sm$air_time2 <- flights.sm$air_time^2
flights.sm$air_time3 <- flights.sm$air_time^3
flights.sm$distance2 <- flights.sm$distance^2
flights.sm$distance3 <- flights.sm$distance^3

flights.sm$dep_delay_air_time <- flights.sm$dep_delay * flights.sm$air_time
flights.sm$dep_delay_air_time2 <- flights.sm$dep_delay * flights.sm$air_time2
flights.sm$dep_delay_air_time3 <- flights.sm$dep_delay * flights.sm$air_time3
flights.sm$dep_delay2_air_time <- flights.sm$dep_delay2 * flights.sm$air_time
flights.sm$dep_delay2_air_time2 <- flights.sm$dep_delay2 * flights.sm$air_time2
flights.sm$dep_delay2_air_time3 <- flights.sm$dep_delay2 * flights.sm$air_time3
flights.sm$dep_delay3_air_time <- flights.sm$dep_delay3 * flights.sm$air_time
flights.sm$dep_delay3_air_time2 <- flights.sm$dep_delay3 * flights.sm$air_time2
flights.sm$dep_delay3_air_time3 <- flights.sm$dep_delay3 * flights.sm$air_time3

flights.sm$dep_delay_sched_dep_time <- flights.sm$dep_delay * flights.sm$sched_dep_time
flights.sm$dep_delay_sched_dep_time2 <- flights.sm$dep_delay * flights.sm$sched_dep_time2
flights.sm$dep_delay_sched_dep_time3 <- flights.sm$dep_delay * flights.sm$sched_dep_time3
flights.sm$dep_delay2_sched_dep_time <- flights.sm$dep_delay2 * flights.sm$sched_dep_time
flights.sm$dep_delay2_sched_dep_time2 <- flights.sm$dep_delay2 * flights.sm$sched_dep_time2
flights.sm$dep_delay2_sched_dep_time3 <- flights.sm$dep_delay2 * flights.sm$sched_dep_time3
flights.sm$dep_delay3_sched_dep_time <- flights.sm$dep_delay3 * flights.sm$sched_dep_time
flights.sm$dep_delay3_sched_dep_time2 <- flights.sm$dep_delay3 * flights.sm$sched_dep_time2
flights.sm$dep_delay3_sched_dep_time3 <- flights.sm$dep_delay3 * flights.sm$sched_dep_time3

flights.sm$air_time_sched_dep_time <- flights.sm$air_time * flights.sm$sched_dep_time
flights.sm$air_time_sched_dep_time2 <- flights.sm$air_time * flights.sm$sched_dep_time2
flights.sm$air_time_sched_dep_time3 <- flights.sm$air_time * flights.sm$sched_dep_time3
flights.sm$air_time2_sched_dep_time <- flights.sm$air_time2 * flights.sm$sched_dep_time
flights.sm$air_time2_sched_dep_time2 <- flights.sm$air_time2 * flights.sm$sched_dep_time2
flights.sm$air_time2_sched_dep_time3 <- flights.sm$air_time2 * flights.sm$sched_dep_time3
flights.sm$air_time3_sched_dep_time <- flights.sm$air_time3 * flights.sm$sched_dep_time
flights.sm$air_time3_sched_dep_time2 <- flights.sm$air_time3 * flights.sm$sched_dep_time2
flights.sm$air_time3_sched_dep_time3 <- flights.sm$air_time3 * flights.sm$sched_dep_time3

# create full model with interaction terms
M6 <- lm(arr_delay ~ dep_delay + dep_delay2 + dep_delay3 + air_time + air_time2 + air_time3 + sched_dep_time + sched_dep_time2 + sched_dep_time3 + distance + distance2             +distance3 + dep_delay_air_time + dep_delay_air_time2 + dep_delay_air_time3
          +dep_delay2_air_time + dep_delay2_air_time2 + dep_delay2_air_time3
          +dep_delay3_air_time + dep_delay3_air_time2+dep_delay3_air_time3
          +dep_delay_sched_dep_time+dep_delay_sched_dep_time2+dep_delay_sched_dep_time3
          +dep_delay2_sched_dep_time+dep_delay2_sched_dep_time2+dep_delay2_sched_dep_time3
          +dep_delay3_sched_dep_time+dep_delay3_sched_dep_time2+dep_delay3_sched_dep_time3
          +air_time_sched_dep_time+air_time_sched_dep_time2+air_time_sched_dep_time3
          +air_time2_sched_dep_time+air_time2_sched_dep_time2+air_time2_sched_dep_time3
          +air_time3_sched_dep_time+air_time3_sched_dep_time2+air_time3_sched_dep_time3, data=flights.sm)

summary(M6)
```

```{r}
# perform backward stepwise regression
M7 <- step(M6, direction = "backward", scope = list(lower = ~ 1, upper = M6))
summary(M7)
```

dep_delay_air_time, dep_delay2_air_time3, dep_delay_sched_dep_time, dep_delay3_sched_dep_time were dropped during the step regression. Each of the variable from summary from dep_delay_air_time2 is an interaction variable.


Intercept is -2.260e+01 when a IVs and interaction variables are zeroes.  
dep_delay                   means there is a increase of  9.507e-01 arr_delay corresponding to a unit increase in dep_delay of power 2 

air_time                    means there is a increase of  7.546e-01 arr_delay corresponding to a unit increase in air_time of power 1 

air_time3                   means there is a increase of -7.786e-07 arr_delay corresponding to a unit increase in air_time of power 3 

sched_dep_time              means there is a increase of  3.791e-03 arr_delay corresponding to a unit increase in sched_dep_time of power 1 

sched_dep_time2             means there is a increase of -1.354e-06 arr_delay corresponding to a unit increase in sched_dep_time of power 2 

distance                    means there is a increase of -1.198e-01 arr_delay corresponding to a unit increase in distance of power 1

distance2                   means there is a increase of  1.518e-05 arr_delay corresponding to a unit increase in distance of power 2 

distance3                   means there is a increase of -2.139e-09 arr_delay corresponding to a unit increase in distance of power 3 

dep_delay_air_time2         interaction variable is responsible for a increase in arr_delay of  1.364e-06 for unit increase in itself

dep_delay_air_time3         interaction variable is responsible for a increase in arr_delay of -2.716e-09 for unit increase in itself

dep_delay2_air_time         interaction variable is responsible for a increase in arr_delay of -2.737e-06 for unit increase in itself

dep_delay2_air_time2        interaction variable is responsible for a increase in arr_delay of  6.014e-09 for unit increase in itself

dep_delay3_air_time         interaction variable is responsible for a increase in arr_delay of  4.575e-09 for unit increase in itself

dep_delay3_air_time2        interaction variable is responsible for a increase in arr_delay of -1.411e-11 for unit increase in itself

dep_delay3_air_time3        interaction variable is responsible for a increase in arr_delay of  9.769e-15 for unit increase in itself

dep_delay_sched_dep_time2   interaction variable is responsible for a increase in arr_delay of  1.276e-07 for unit increase in itself

dep_delay_sched_dep_time3   interaction variable is responsible for a increase in arr_delay of -5.248e-11 for unit increase in itself

dep_delay2_sched_dep_time   interaction variable is responsible for a increase in arr_delay of  5.264e-07 for unit increase in itself

dep_delay2_sched_dep_time2  interaction variable is responsible for a increase in arr_delay of -4.585e-10 for unit increase in itself

dep_delay2_sched_dep_time3  interaction variable is responsible for a increase in arr_delay of  6.981e-14 for unit increase in itself

dep_delay3_sched_dep_time   interaction variable is responsible for a increase in arr_delay of -6.475e-10 for unit increase in itself

dep_delay3_sched_dep_time2  interaction variable is responsible for a increase in arr_delay of  3.451e-13 for unit increase in itself

air_time_sched_dep_time     interaction variable is responsible for a increase in arr_delay of  6.019e-04 for unit increase in itself

air_time_sched_dep_time2    interaction variable is responsible for a increase in arr_delay of -4.943e-07 for unit increase in itself

air_time_sched_dep_time3    interaction variable is responsible for a increase in arr_delay of  1.229e-10 for unit increase in itself

air_time2_sched_dep_time    interaction variable is responsible for a increase in arr_delay of -2.366e-06 for unit increase in itself

air_time2_sched_dep_time2   interaction variable is responsible for a increase in arr_delay of  1.418e-09 for unit increase in itself

air_time2_sched_dep_time3   interaction variable is responsible for a increase in arr_delay of -2.386e-13 for unit increase in itself

air_time3_sched_dep_time    interaction variable is responsible for a increase in arr_delay of  3.501e-09 for unit increase in itself

air_time3_sched_dep_time2   interaction variable is responsible for a increase in arr_delay of -1.323e-12 for unit increase in itself

dep_delay_air_time2         means there is a increase of  1.364e-06 dep_delay of power 1 corresponding to a unit increase in air_time of power 2 

dep_delay_air_time3         means there is a increase of -2.716e-09 dep_delay of power 1 corresponding to a unit increase in air_time of power 3 

dep_delay2_air_time         means there is a increase of -2.737e-06 dep_delay of power 2 corresponding to a unit increase in air_time of power 1 

dep_delay2_air_time2        means there is a increase of  6.014e-09 dep_delay of power 2 corresponding to a unit increase in air_time of power 2 

dep_delay3_air_time         means there is a increase of  4.575e-09 dep_delay of power 3 corresponding to a unit increase in air_time of power 1 

dep_delay3_air_time2        means there is a increase of -1.411e-11 dep_delay of power 3 corresponding to a unit increase in air_time of power 2 

dep_delay3_air_time3        means there is a increase of  9.769e-15 dep_delay of power 3 corresponding to a unit increase in air_time of power 3

dep_delay_sched_dep_time2   means there is a increase of  1.276e-07 dep_delay of power 1 corresponding to a unit increase in air_time of power 2 

dep_delay_sched_dep_time3   means there is a increase of -5.248e-11 dep_delay of power 1 corresponding to a unit increase in air_time of power 3 

dep_delay2_sched_dep_time   means there is a increase of  5.264e-07 dep_delay of power 2 corresponding to a unit increase in air_time of power 1 

dep_delay2_sched_dep_time2  means there is a increase of -4.585e-10 dep_delay of power 2 corresponding to a unit increase in air_time of power 2 

dep_delay2_sched_dep_time3  means there is a increase of  6.981e-14 dep_delay of power 2 corresponding to a unit increase in air_time of power 3 

dep_delay3_sched_dep_time   means there is a increase of -6.475e-10 dep_delay of power 3 corresponding to a unit increase in air_time of power 1 

dep_delay3_sched_dep_time2  means there is a increase of  3.451e-13 dep_delay of power 3 corresponding to a unit increase in air_time of power 2 

air_time_sched_dep_time     means there is a increase of  6.019e-04 dep_delay of power 1 corresponding to a unit increase in air_time of power 1 

air_time_sched_dep_time2    means there is a increase of -4.943e-07 dep_delay of power 1 corresponding to a unit increase in air_time of power 2 

air_time_sched_dep_time3    means there is a increase of  1.229e-10 dep_delay of power 1 corresponding to a unit increase in air_time of power 3 

air_time2_sched_dep_time    means there is a increase of -2.366e-06 dep_delay of power 2 corresponding to a unit increase in air_time of power 1 

air_time2_sched_dep_time2   means there is a increase of  1.418e-09 dep_delay of power 2 corresponding to a unit increase in air_time of power 2 

air_time2_sched_dep_time3   means there is a increase of -2.386e-13 dep_delay of power 2 corresponding to a unit increase in air_time of power 3 

air_time3_sched_dep_time    means there is a increase of  3.501e-09 dep_delay of power 3 corresponding to a unit increase in air_time of power 1 

air_time3_sched_dep_time2   means there is a increase of -1.323e-12 dep_delay of power 3 corresponding to a unit increase in air_time of power 2 

